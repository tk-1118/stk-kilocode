# 测试 CreateTaskWithContext 命令修复\n\n## 问题描述\n\n使用新的 `createTaskWithContext` 指令传递临时系统提示词构建项目时，智能体经常出现：\n\n`\nHN Code is having trouble...\nThis may indicate a failure in the model's thought process or inability to use a tool properly, which can be mitigated with some user guidance (e.g. \"Try breaking down the task into smaller steps\").\n`\n\n## 问题分析\n\n经过排查，发现问题的根本原因是在 `createTaskWithContext` 实现中存在以下问题：\n\n### 1. 重复的任务创建\n\n**问题**：在 `handleTaskWithContext.ts` 中，我们调用了 `provider.createTask()` 创建任务后，又发送了 `newChat` 消息到 webview：\n\n`typescript\n// 错误的实现\nconst task = await provider.createTask(userPrompt, images, undefined, {\n    temporarySystemPrompt,\n})\n\n// 这里重复发送了 newChat 消息，导致状态冲突\nawait provider.postMessageToWebview({\n    type: \"invoke\",\n    invoke: \"newChat\",\n    text: userPrompt,\n    images\n})\n`\n\n**影响**：这导致了重复的任务创建或状态冲突，使智能体进入错误状态。\n\n### 2. 不必要的延迟\n\n**问题**：在模式切换后添加了不必要的 100ms 延迟：\n\n`typescript\n// 不必要的延迟\nif (mode) {\n    await provider.handleModeSwitch(mode)\n    await new Promise(resolve => setTimeout(resolve, 100)) // 不需要\n}\n`\n\n**影响**：`handleModeSwitch` 本身就是异步的，已经等待完成，不需要额外延迟。\n\n## 修复方案\n\n### 1. 移除重复的 newChat 消息\n\n`typescript\n// 修复后的实现\nconst task = await provider.createTask(userPrompt, images, undefined, {\n    temporarySystemPrompt,\n})\n\n// 移除重复的 newChat 消息发送\n// createTask 会自动处理 webview 更新\n`\n\n### 2. 移除不必要的延迟\n\n`typescript\n// 修复后的实现\nif (mode) {\n    await provider.handleModeSwitch(mode)\n    // handleModeSwitch 是异步的，已经等待完成，不需要额外延迟\n}\n`\n\n### 3. 优化临时系统提示词格式\n\n``typescript\n// 更清晰的标题\nif (this.temporarySystemPrompt) {\n    return `${baseSystemPrompt}\\n\\n## 临时任务指令\\n\\n${this.temporarySystemPrompt}`\n}\n``\n\n## 测试步骤\n\n### 1. 基本功能测试\n\n在另一个扩展中调用：\n\n`typescript\n// 基本调用\nawait vscode.commands.executeCommand('kilo-code.createTaskWithContext', {\n    userPrompt: '请帮我创建一个简单的 React 组件'\n});\n`\n\n### 2. 带临时系统提示词测试\n\n``typescript\n// 带临时系统提示词\nawait vscode.commands.executeCommand('kilo-code.createTaskWithContext', {\n    userPrompt: '请优化这个组件的性能',\n    temporarySystemPrompt: `你是一个专业的 React 性能优化专家。\n    \n请重点关注：\n1. 组件渲染优化\n2. 内存泄漏防护\n3. 状态管理优化\n4. 代码分割建议\n\n请提供具体的代码示例和解释。`\n});\n``\n\n### 3. 带模式切换测试\n\n`typescript\n// 带模式切换\nawait vscode.commands.executeCommand('kilo-code.createTaskWithContext', {\n    userPrompt: '请设计一个用户管理系统的架构',\n    mode: 'architect',\n    temporarySystemPrompt: '请从系统架构师的角度，设计一个可扩展的用户管理系统。'\n});\n`\n\n## 预期结果\n\n修复后，应该能够：\n\n1. **正常创建任务**：不再出现 \"HN Code is having trouble\" 错误\n2. **正确应用临时系统提示词**：智能体会按照临时系统提示词的指导进行工作\n3. **模式切换正常**：指定的模式能够正确切换\n4. **任务完成后清理**：临时系统提示词在任务结束后自动清除\n\n## 验证方法\n\n1. **检查任务创建**：确认任务能够正常启动，不出现错误对话框\n2. **检查系统提示词**：通过智能体的回复可以看出是否遵循了临时系统提示词\n3. **检查模式切换**：确认 UI 中的模式显示正确\n4. **检查清理机制**：创建新任务时，之前的临时系统提示词不会影响新任务\n\n## 注意事项\n\n1. **参数验证**：确保 `userPrompt` 参数不为空\n2. **错误处理**：如果创建失败，会显示相应的错误消息\n3. **兼容性**：不影响现有的任务创建流程\n4. **性能**：移除了不必要的延迟，提高了响应速度\n"
